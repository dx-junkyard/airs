# データ分析AIエージェント

## 概要

蓄積された獣害通報データを、職員が自然言語で問い合わせて分析できるAIエージェント。Vertex AI（Gemini）がユーザーの質問をSQLに変換し、データベースを検索して結果を表形式で返す。Excelでの手動集計を不要にし、専門的なデータ分析スキルがなくても高度な分析を実行可能にする。

## 課題

### 1. Excelベースの手動分析

職員へのヒアリングから、現場では獣害データをExcelにダウンロードし、手作業でフィルタリング・集計・グラフ作成を行っていることが判明した。件数の集計、地域別の傾向把握、時系列での変化分析など、日常的に必要な分析のたびにExcel操作が発生する。

### 2. 高度なツールスキルへの依存

ピボットテーブル、VLOOKUP、条件付き集計などのExcel関数を使いこなせる職員は限られる。GIS（地理情報システム）による空間分析やSQLによるデータベース直接検索は、さらに専門性が高く、多くの職員にとって実質的に利用不可能。結果として、分析業務が特定の担当者に集中する。

### 3. 分析の即時性の欠如

「今月の通報件数は？」「クマの目撃が多い地域は？」といった日常的な問い合わせでも、データのダウンロード→Excel加工→結果確認というステップが必要になり、意思決定までにタイムラグが生じる。

## ソリューション

### 自然言語によるデータ問い合わせ

職員はチャット画面で日本語の質問を入力するだけで、AIが適切なSQLクエリを生成・実行し、結果を返す。

**対応可能な質問の例:**

| 質問の種類 | 具体例 |
|-----------|--------|
| 件数集計 | 「今月の通報件数は何件ですか？」 |
| カテゴリ別集計 | 「動物種別ごとの通報件数を教えてください」 |
| ステータス確認 | 「確認待ちの通報は何件ありますか？」 |
| 地域分析 | 「最も通報が多い地域（丁目単位）はどこですか？」 |
| イベント分析 | 「イベント数と通報件数の関係を教えてください」 |
| 空間分析 | 「特定の地点から5km圏内の通報を検索」（PostGIS対応） |

### AIによるSQL生成と実行

Vertex AI（Gemini）にデータベーススキーマ（reports、events、event_reportsテーブル）とカラム定義、PostGISの空間クエリ例を事前知識として提供。ユーザーの自然言語をSQLに変換し、以下のフローで処理する。

```
職員の質問（日本語）
  ↓
Vertex AI（Gemini）がSQL生成（tool_use: runSql）
  ↓
SQLセキュリティ検証（4層防御）
  ↓
PostgreSQL実行（最大1000行）
  ↓
結果を表形式で表示 + AIが日本語で解説
```

Vertex AI（Gemini）は1回の応答で最大5回までSQLを実行でき、複雑な分析でも段階的にデータを取得して回答を組み立てる。

### SQLセキュリティの4層防御

AIが生成するSQLに対して、以下の多層防御で安全性を担保する。

| 層 | 内容 |
|----|------|
| 1. 文の種類制限 | SELECTのみ許可。INSERT/UPDATE/DELETE/DROP等は拒否 |
| 2. キーワード検査 | UNION、INFORMATION_SCHEMA、PG_、SLEEP等34個の危険キーワードをブロック |
| 3. テーブル制限 | reports、events、event_reportsのみアクセス可能 |
| 4. 行数制限 | LIMIT 1000を強制付与。大量データの取得を防止 |

### 結果表示とインタラクション

- **表形式**: SQLの結果をテーブルで表示。動物種別やステータスは日本語ラベルに自動変換
- **AI解説**: 結果に対するVertex AI（Gemini）の日本語解説をMarkdown形式で表示
- **CSV出力**: テーブルからCSVファイルをダウンロード可能（Excel互換のUTF-8 BOM付き）
- **地図連携**: 緯度経度を含む行をクリックすると、地図上で該当地点を表示
- **フォローアップ提案**: 回答後に文脈に応じた次の質問を3件自動生成

### ストリーミング応答

Vercel AI SDKのストリーミング機能により、SQL実行結果とAIの解説がリアルタイムで画面に表示される。大量データの分析でも、待ち時間を最小化する。

## 効果

### 分析の民主化

SQLやExcel関数の知識がなくても、日本語で質問するだけでデータ分析が可能になる。特定の担当者に依存せず、すべての職員が自らデータを参照・分析できる。

### 意思決定の迅速化

データのダウンロード→Excel加工→確認のプロセスが、チャットでの質問→即時回答に短縮される。「クマの目撃が増えている地域はどこか」といった問い合わせに、その場で回答が得られる。

### 分析の高度化

PostGISによる空間検索、複数テーブルの結合、時系列集計など、Excelでは困難な分析もAIが自動的にSQLを組み立てて実行する。職員が意識せずとも、高度なデータベース機能を活用した分析結果が得られる。

### フォローアップによる深掘り

AIが回答後に関連する次の質問を提案することで、職員が自発的には思いつかなかった分析の切り口に気づく機会を提供する。データに基づく対策立案を支援する。
